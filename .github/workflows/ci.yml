name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
        django-version: ["3.2", "4.2", "5.0"]
        exclude:
          - python-version: "3.8"
            django-version: "5.0"
          - python-version: "3.9"
            django-version: "5.0"
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install django~=${{ matrix.django-version }}.0
        pip install -e ".[dev]"
    
    - name: Run tests with coverage
      run: |
        pytest -v --cov=turbodrf --cov-report=term --cov-report=json

    - name: Extract coverage percentage
      if: matrix.python-version == '3.11' && matrix.django-version == '4.2'
      run: |
        COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered_display'])")
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
        echo "Coverage: $COVERAGE%"

    - name: Create coverage badge
      if: matrix.python-version == '3.11' && matrix.django-version == '4.2' && github.ref == 'refs/heads/main'
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: turbodrf-coverage.json
        label: coverage
        message: ${{ env.COVERAGE }}%
        color: ${{ env.COVERAGE > 90 && 'brightgreen' || env.COVERAGE > 80 && 'green' || env.COVERAGE > 70 && 'yellowgreen' || env.COVERAGE > 60 && 'yellow' || env.COVERAGE > 50 && 'orange' || 'red' }}